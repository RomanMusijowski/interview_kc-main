 ## Token-service (overview)

This service implements the OAuth2 authorization-code exchange and downstream processing pipeline:

- Exposes GET /token?code=<auth_code> (see [`com.finance.tokenservice.route.RestRoutes`](token-service/src/main/kotlin/com/finance/tokenservice/route/RestRoutes.kt)).
- Exchanges the authorization code for an access token with Keycloak using a JWT client assertion generated by [`com.finance.tokenservice.security.JwtAssertionGenerator`](token-service/src/main/kotlin/com/finance/tokenservice/security/JwtAssertionGenerator.kt) (private key loaded by [`com.finance.tokenservice.security.KeyStoreLoader`](token-service/src/main/kotlin/com/finance/tokenservice/security/KeyStoreLoader.kt)). The exchange is performed by [`com.finance.tokenservice.processor.KeycloakProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/KeycloakProcessor.kt) using the REST client [`com.finance.tokenservice.client.KeycloakRestClient`](token-service/src/main/kotlin/com/finance/tokenservice/client/KeycloakRestClient.kt) and modeled by [`com.finance.tokenservice.model.KeycloakTokenResponse`](token-service/src/main/kotlin/com/finance/tokenservice/model/KeycloakTokenResponse.kt).

- After a successful token exchange, the service calls the transactions service via [`com.finance.tokenservice.processor.TransactionProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/TransactionProcessor.kt) using [`com.finance.tokenservice.client.TransactionRestClient`](token-service/src/main/kotlin/com/finance/tokenservice/client/TransactionRestClient.kt).

- Transactions are transformed into Kafka messages by [`com.finance.tokenservice.processor.TransactionToMessageProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/TransactionToMessageProcessor.kt) using [`com.finance.tokenservice.formatter.KafkaMessageFormatter`](token-service/src/main/kotlin/com/finance/tokenservice/formatter/KafkaMessageFormatter.kt). Each message is logged with [`com.finance.tokenservice.processor.TransactionIdLoggingProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/TransactionIdLoggingProcessor.kt) before being published to Kafka. The final HTTP response is formatted by [`com.finance.tokenservice.processor.SuccessResponseProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/SuccessResponseProcessor.kt) with help from [`com.finance.tokenservice.formatter.ResponseFormatter`](token-service/src/main/kotlin/com/finance/tokenservice/formatter/ResponseFormatter.kt).

## Kafka message format

Messages produced to the configured topic (see [`com.finance.tokenservice.config.KafkaConfig`](token-service/src/main/kotlin/com/finance/tokenservice/config/KafkaConfig.kt) and `src/main/resources/application.properties`) follow this structure (JSON):

```json
{
  "userId": "user-123",
  "transaction": {
    "id": "tx-1",
    "accountId": "acc-1",
    "amount": 10.50,
    "currency": "USD",
    "type": "DEBIT",
    "description": "desc",
    "merchantName": "merchant",
    "category": "cat",
    "timestamp": "2020-01-01T12:00:00",
    "status": "COMPLETED",
    "reference": "ref",
    "balance": 100.00
  },
  "messageTimestamp": "2023-01-01T12:00:00Z"
}
```

This format is produced by [`com.finance.tokenservice.formatter.KafkaMessageFormatter.formatForKafka`](token-service/src/main/kotlin/com/finance/tokenservice/formatter/KafkaMessageFormatter.kt).

## How to run

1. Start infrastructure (Keycloak, Kafka, etc.)
   - Use the provided docker-compose: [docker-compose.yml](docker-compose.yml) or run the project setup script: [setup.sh](setup.sh).
     - Example: docker-compose up -d
     - Or: ./setup.sh (script creates docker-compose and starts required services)

2. Start transactions service (port 8082)
   - From project root:
```bash
./gradlew :transactions-service:quarkusDev
```
   - See [`transactions-service/README.md`](transactions-service/README.md) for details.

3. Start token service (port 8081)
```bash
./gradlew :token-service:quarkusDev
```

Configuration of Keycloak endpoint, keystore path and Kafka topic are in:
- [token-service/src/main/resources/application.properties](token-service/src/main/resources/application.properties)

## How to test

- End-to-end (real Keycloak):
  1. Open the Keycloak auth URL:
     http://localhost:8080/realms/finance-app/protocol/openid-connect/auth?client_id=finance-client&redirect_uri=http://localhost:8081/token&response_type=code&scope=openid
  2. After login Keycloak redirects to /token?code=<auth_code>. The token-service will:
     - Exchange the code (see [`com.finance.tokenservice.processor.KeycloakProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/KeycloakProcessor.kt))
     - Fetch transactions from transactions-service (see [`com.finance.tokenservice.processor.TransactionProcessor`](token-service/src/main/kotlin/com/finance/tokenservice/processor/TransactionProcessor.kt))
     - Publish messages to Kafka topic configured in `finance.kafka.topic` (see [`com.finance.tokenservice.config.KafkaConfig`](token-service/src/main/kotlin/com/finance/tokenservice/config/KafkaConfig.kt))

- Quick curl-based test (if Keycloak is not available, you can run unit tests or mock clients):
```bash
# Simulate an auth-code request (requires Keycloak or a test stub)
curl "http://localhost:8081/token?code=YOUR_AUTH_CODE"
```

- Run unit tests:
```bash
./gradlew :token-service:test
```
Unit tests include coverage for processors and formatters (see tests under `token-service/src/test/kotlin`).

## Troubleshooting

- Keystore: ensure `finance.keycloak.keystore-path` points to a valid JKS/PKCS12 and `finance.keycloak.keystore-password` is correct (see [`com.finance.tokenservice.security.KeyStoreLoader`](token-service/src/main/kotlin/com/finance/tokenservice/security/KeyStoreLoader.kt)).
- If Keycloak returns HTTP errors, look at [`com.finance.tokenservice.processor.error.KeycloakErrorMapper`](token-service/src/main/kotlin/com/finance/tokenservice/processor/error/KeycloakErrorMapper.kt) and related tests (`token-service/src/test/kotlin/com/finance/tokenservice/processor/error/KeycloakErrorMapperTest.kt`).

}